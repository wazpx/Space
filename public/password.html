import express from 'express';
import session from 'express-session';
import bodyParser from 'body-parser';
import path from 'path';

const app = express();
const PORT = process.env.PORT || 3000;
const __dirname = path.resolve();

// Middleware to parse incoming request bodies (e.g., from forms)
app.use(bodyParser.urlencoded({ extended: true }));

// Middleware to manage sessions
app.use(session({
  secret: 'super-secret-key', // Change this to something more secure
  resave: false,
  saveUninitialized: true,
  cookie: { secure: false } // Set to true if you're using https
}));

// ðŸ”’ Middleware to protect all routes and force redirect to /password
app.use((req, res, next) => {
  // If the user is authenticated, allow access to the page
  if (req.session.authenticated) {
    return next();
  }

  // Force redirect to /password for all requests if not authenticated
  res.redirect('/password');
});

// Serve the password page (force password protection)
app.get('/password', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'password.html')); // Serve your password.html file
});

// Handle password submission
app.post('/check-password', (req, res) => {
  const { password } = req.body;

  // Check if password is correct
  if (password === 'dimitri') {
    req.session.authenticated = true; // Set session variable to indicate user is logged in
    return res.redirect('/'); // Redirect to homepage or any other route after successful login
  } else {
    // Redirect to Google Classroom if password is wrong
    return res.redirect('https://classroom.google.com/?pli=1');
  }
});

// Serve static files or protected content (e.g., public assets, routes, etc.)
app.use(express.static(path.join(__dirname, 'public')));

// Optional: Logout route to destroy session
app.get('/logout', (req, res) => {
  req.session.destroy(() => {
    res.redirect('/password'); // Redirect to login page after logout
  });
});

// Start the server
app.listen(PORT, () => {
  console.log(`âœ… Server running on http://localhost:${PORT}`);
});
